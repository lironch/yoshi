## Editor flow migration guide

![E52C44BF-55C7-407E-AA9C-0AE07E1B7A71](https://user-images.githubusercontent.com/1521229/77897090-e2d24480-7281-11ea-9cbf-e3fdc4d8c509.PNG)


#### Table of contents
- [Intro](#intro)
- [Update package.json](#update-packagejson)
- [Remove all boilerplate files:](#remove-all-boilerplate-files)
- [Group files by components:](#group-files-by-components)
- [Update your urls in Dev Center](#update-your-urls-in-dev-center)
- [Done](#done-)
- [Making all changes smooth and safe](#making-all-changes-smooth-and-safe)

#### Intro

This is a migration guide for apps created via `out-of-iframe` option using `create-yoshi-app`.
Editor flow removes a lot of boilerplate, so prepare your `CMD` and `DELETE` buttons on the keyboard üòâ.

The project structure will be updated as well. We are going to group everything by widgets. All things related to a single widget will be in a single directory.
This guide supposes you preserve the structure provided by the `ooi` template, so if you created additional directories, please verify they're needed and update the relevant paths in `import` statements.

> Please note, with editor flow we are going to provide better local experience. If you are using 2 different apps (pointed to localhost and pointed to production) for development, please consider using only production one. We are going to override production urls for local ones using query params. Please check the [disucssuion and solution](https://github.com/wix/yoshi/issues/2043#issuecomment-599510574).

Ok, let's start üöÄ

#### Update package.json
- Remove `yoshi` devDependency: `npm uninstall --save-dev yoshi`
- Add `yoshi-flow-editor` devDependency: `npm install --save-dev yoshi-flow-editor`
- Add `yoshi-flow-editor-runtime` dependency: `npm install --save yoshi-flow-editor-runtime`
- Update `yoshi` to `yoshi-flow-editor` in `scripts`

*package.json*
```diff
"scripts": {
- "start": "yoshi start"
+ "start": "yoshi-flow-editor start"
Consider all scripts updated
},
"devDependencies": {
-  "yoshi": "^4.0.0"
+  "yoshi-flow-editor": "^4.0.0"
},
"dependencies": {
+  "yoshi-flow-editor-runtime": "^4.0.0"
...
} 
```

#### Remove all boilerplate files:
- Go to `viewerApp` directory. Move all test files to `__tests__` directory in the root. Remove `viewerApp` directory. `yoshi-flow-editor` will generate the `viewerScript` for you!
- Provide the same steps for `editorApp` and `settingsPanel` directories. *We are going to generate the `editor app`/`settings panel` wrappers under the hood.*
- Remove `templates` directory. *Editor flow will render editor app and settings panel w/o template files.*


#### Group files by components:
If you have component-separated monorepo configured we recommend collecting all projects into a single one.
- Every directory in `src/components` represents a single component. For single-component apps that were generated by out-of-iframe yoshi template, you need to rename your `components/Widget` directory to the name of the component. Try to create simple name related to the app in general. You'll already have the artifact name in base url, so no need to duplicate it in the name. As an example, if your app is Pizza üçï instead of `PizzaSauce` and `PizzaArtichoke`, call it `Sauce` and `Artichoke`.
- Verify your component's directory has 3 main files (or directories with `index.ts`):
  - `Widget` - `export default` a React Component which will be rendered in editor and viewer.
  - `controller.ts` - `export default createController` function, which will be executed in Web Worker environment.
  
  For old `ooi` apps, it called `createAppController` and have to be exported via name notation. So update it to `default` export:
  ```diff
  - export const createAppController
  + export default createController
  ```
  As you can see, we would also suggest to rename this function to `createController` since this is not exactly app controller, but rather **widget**'s one.
  - `Settings` - `export default` a React Component. Will be rendered in editor after double-clicking on component or picking "Settings" tab.

- Create `.component.json` file for each component (in component's dir) and paste your widget id as an `"id"` field. You probably can take this value from the former `viewerApp` directory. Usually you need it to match `createController` function with the platform's `controllerConfig`. Also, you can take it from http://dev.wix.com
- Create `.application.json` file in the project's root. Add `"appDefinitionId": YOUR_APP_DEFINITION_ID` here.

#### Update your urls in [Dev Center](https://dev.wix.com/dc3/my-apps)
Statics url's will be the same, except bundle names will be a bit different:
- *viewerScript*: `baseStaticsUrl/viewerScript.bundle.min.js`
- *editorScript*: `baseStaticsUrl/editorScript.bundle.min.js`
- *viewerWidget*: `baseStaticsUrl/{name}ViewerWidget.bundle.min.js`. You'll have each bundle per component. Here `name` is a simply name of the component's directory. For example for directory called `Artichoke`, bundle name will be `ArtichokeViewerWidget.bundle.js`.
- *editorApp*: `baseStaticsUrl/editor/{name}.html`. For example `editor/Artichoke.html`
- *settingsPanel*: `baseStaticsUrl/settings/{name}.html`. For example `settings/Artichoke.html`

Update your components in dev center to match requirements above. As a baseStaticsUrl, you can usually use static.parastorage by knowing you `artifactId`.
For example `https://static.parastorage.com/services/{artifactId}/1.0.0/viewerScript.bundle.min.js`

#### Done ‚úÖ
üí™ From now you are using new editor flow!
ü§ûJust run `npm start` and `npm test` to verify everything working. 
ü•¥ If something stopped working please [create an issue](https://github.com/wix/yoshi/issues/new/choose) or ask in `#yoshi` slack channel.

#### Making all changes smooth and safe
Since any migration is a risk, we can greatly reduce chances to break production using some of these approaches:
- **Dry run:** Instead of updating current app, create new one with own artifact. Add new app in Dev Center. Verify it's working both locally and on the production. Please note, you'll still have `DRAFT` type of the app. Since you probably don't want to publish this app to the real world app market.
- **Gradually open it using `client-spec-map`:** [Create new experiment](https://github.com/wix-private/fed-handbook/blob/master/EXPERIMENTS.md) and add it to [Client Spec Map Experiments](https://bo.wix.com/client-spec-map-experiment-server/). Override all urls to the new artifact and enable it to limited audience. Please check [the Client Spec Map Experiments guide](https://github.com/wix-private/meta-site/tree/master/wix-meta-site-server/app-store-service/client-spec-map-experiment-server#change).
